<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<link rel="shortcut icon" type="image/png" href="themes/favicon.png">
<title>Gestion du routage : Dispositif de Gestion des Echanges</title>
<link rel="stylesheet" href="themes/css/html-zenika.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Gestion du routage : Dispositif de Gestion des Echanges</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#contexte">2. Contexte</a>
<ul class="sectlevel2">
<li><a href="#architecture-fonctionnelle">2.1. Architecture fonctionnelle</a></li>
<li><a href="#services-webmethods">2.2. Services webMethods</a>
<ul class="sectlevel3">
<li><a href="#routage-diffusion-messages">2.2.1. Routage Diffusion Messages</a></li>
</ul>
</li>
<li><a href="#présentation-de-l-écran-de-simulation">2.3. Présentation de l’écran de simulation</a></li>
</ul>
</li>
<li><a href="#packages-webmethods">3. Packages webMethods</a>
<ul class="sectlevel2">
<li><a href="#sgebpmdf-routage-diffusion-fichier">3.1. SgeBpmDf : routage Diffusion Fichier</a>
<ul class="sectlevel3">
<li><a href="#services-publics">3.1.1. Services publics</a>
<ul class="sectlevel4">
<li><a href="#sgebpmdf-pub-routefile">sgeBpmDf.pub:routeFile</a>
<ul class="sectlevel5">
<li><a href="#déclenchement">Déclenchement</a></li>
<li><a href="#traitement">Traitement</a></li>
<li><a href="#cycle-de-vie-du-traitement">Cycle de vie du traitement</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sgebpmdm-routage-diffusion-messages">3.2. SgeBpmDm : routage Diffusion Messages</a>
<ul class="sectlevel3">
<li><a href="#services-publics-2">3.2.1. Services publics</a>
<ul class="sectlevel4">
<li><a href="#sgecommonsdocs-docs-dm-bpm-startbpmdm">sgeCommonsDocs.docs.dm.bpm:StartBpmDm</a>
<ul class="sectlevel5">
<li><a href="#déclenchement-2">Déclenchement</a></li>
<li><a href="#traitement-2">Traitement</a></li>
<li><a href="#cycle-de-vie-du-traitement-2">Cycle de vie du traitement</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#gestion-des-anomalies">3.3. Gestion des anomalies</a></li>
<li><a href="#documents-wm">3.4. Documents WM</a>
<ul class="sectlevel3">
<li><a href="#sgecommonsdocs-docs-dm-bpm-data-non-publiable">3.4.1. sgeCommonsDocs.docs.dm.bpm:Data (non publiable)</a></li>
</ul>
</li>
<li><a href="#sgebpmcommons">3.5. SgeBpmCommons</a>
<ul class="sectlevel3">
<li><a href="#services-publics-3">3.5.1. Services publics</a>
<ul class="sectlevel4">
<li><a href="#sgebpmcommons-sched-reinitcacherfo">sgeBpmCommons.sched:reinitCacheRFO</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#jars">4. Jars</a>
<ul class="sectlevel2">
<li><a href="#cacherfo-initrisquelistfromrfo">4.1. CacheRFO.initRisqueListFromRFO</a></li>
<li><a href="#cacherfo-getrisquelistfromrfo">4.2. CacheRFO.getRisqueListFromRFO</a></li>
<li><a href="#genericroutingmanager-routewithrestriction">4.3. GenericRoutingManager.routeWithRestriction</a></li>
<li><a href="#genericroutingmanager-routewithrisques">4.4. GenericRoutingManager.routeWithRisques</a></li>
<li><a href="#genericroutingmanager-routewithcomplement">4.5. GenericRoutingManager.routeWithComplement</a></li>
<li><a href="#genericroutingmanager-routewithabonnement">4.6. GenericRoutingManager.routeWithAbonnement</a></li>
<li><a href="#genericroutingmanager-routewithdcr">4.7. GenericRoutingManager.routeWithDCR</a></li>
<li><a href="#genericroutingmanager-getfinalresult">4.8. GenericRoutingManager.getFinalResult</a></li>
<li><a href="#dfroutingmanager-storeroutingresult">4.9. DfRoutingManager.storeRoutingResult</a>
<ul class="sectlevel3">
<li><a href="#entrées-sorties">4.9.1. Entrées/Sorties</a></li>
<li><a href="#algorithme">4.9.2. Algorithme</a></li>
</ul>
</li>
<li><a href="#dfroutingmanager-buildendbpmdfdata">4.10. DfRoutingManager.buildEndBpmDfData</a>
<ul class="sectlevel3">
<li><a href="#entrées-sorties-2">4.10.1. Entrées/Sorties</a></li>
<li><a href="#algorithme-2">4.10.2. Algorithme</a></li>
</ul>
</li>
<li><a href="#dmroutingmanager-startmsg">4.11. DmRoutingManager.startMsg</a>
<ul class="sectlevel3">
<li><a href="#déclenchement-3">4.11.1. Déclenchement</a></li>
<li><a href="#entrées-sorties-3">4.11.2. Entrées/Sorties</a></li>
<li><a href="#algorithme-3">4.11.3. Algorithme</a></li>
</ul>
</li>
<li><a href="#dmroutingmanager-startroutemsg">4.12. DmRoutingManager.startRouteMsg</a>
<ul class="sectlevel3">
<li><a href="#déclenchement-4">4.12.1. Déclenchement</a></li>
<li><a href="#entrées-sorties-4">4.12.2. Entrées/Sorties</a></li>
<li><a href="#algorithme-4">4.12.3. Algorithme</a></li>
</ul>
</li>
<li><a href="#dmroutingmanager-endroutemsg">4.13. DmRoutingManager.endRouteMsg</a>
<ul class="sectlevel3">
<li><a href="#déclenchement-5">4.13.1. Déclenchement</a></li>
<li><a href="#entrées-sorties-5">4.13.2. Entrées/Sorties</a></li>
<li><a href="#algorithme-5">4.13.3. Algorithme</a></li>
</ul>
</li>
<li><a href="#dmroutingmanager-endmsg">4.14. DmRoutingManager.endMsg</a>
<ul class="sectlevel3">
<li><a href="#déclenchement-6">4.14.1. Déclenchement</a></li>
<li><a href="#entrées-sorties-6">4.14.2. Entrées/Sorties</a></li>
<li><a href="#algorithme-6">4.14.3. Algorithme</a></li>
</ul>
</li>
<li><a href="#dmroutingmanager-storeroutingresult">4.15. DmRoutingManager.storeRoutingResult</a>
<ul class="sectlevel3">
<li><a href="#entrées-sorties-7">4.15.1. Entrées/Sorties</a></li>
<li><a href="#algorithme-7">4.15.2. Algorithme</a></li>
</ul>
</li>
<li><a href="#dmroutingmanager-buildendbpmdmdata">4.16. DmRoutingManager.buildEndBpmDmData</a>
<ul class="sectlevel3">
<li><a href="#entrées-sorties-8">4.16.1. Entrées/Sorties</a></li>
<li><a href="#algorithme-8">4.16.2. Algorithme</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="icon"><a class="image" href="index.html"><i class="fa fa-home"></i></a></span> ‏ ‏ ‎
<span class="icon"><a class="image" href="STS-Gestion-du-routage.adoc"><i class="fa fa-file-text-o"></i></a></span> ‏ ‏ ‎
<span class="icon"><a class="image" href="STS-Gestion-du-routage.pdf"><i class="fa fa-file-pdf-o"></i></a></span></p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Références</caption>
<colgroup>
<col style="width: 6.25%;">
<col style="width: 6.25%;">
<col style="width: 12.5%;">
<col style="width: 37.5%;">
<col style="width: 37.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Réf.</th>
<th class="tableblock halign-center valign-top">Ver.</th>
<th class="tableblock halign-center valign-top">Date</th>
<th class="tableblock halign-left valign-top">Document</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[01]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">01.6</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">27/04/2017</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SGE_V2_SFG_Spécifications_Fonctionnelles_Générales.docx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spécifications fonctionnelles générales du SGE V2</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[02]</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2018-12-18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAF-architecture.pdf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cadre d’architecture SGE V2, contenant notamment les noms des IS</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[03]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">01.4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">27/04/2017</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SGE_V2_DSF_Dossier_de_Spécifications_Fonctionnelles.docx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spécifications fonctionnelles détaillées du SGE V2</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[04]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">01.0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">29/09/2016</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SGE_V2_FS_Diffuser_un_fichier_(DF).docx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fiche Solution décrivant le routage pour la nature Diffusion Fichier pour le SGE V2</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[05]</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2018-12-18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STS-Cache-Catalogue.pdf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description du cache du catalogue SGE V2</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[06]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">xxx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">xxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ajouter FS DM Batch</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[07]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">xxx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">xxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ajouter FS DM TR</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[08]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">xxx</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">xxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SGE_V2_DSF_Liste_des_codes_d_erreurs.xlsx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Liste des codes d’erreurs SGE V2</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce document décrit les opérations de routage réalisées par l’IS « MET » de l’application SGE V2 pour les natures d’échanges suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Diffusion Fichier</p>
</li>
<li>
<p>Diffusion Messages</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="contexte"><a class="anchor" href="#contexte"></a>2. Contexte</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="architecture-fonctionnelle"><a class="anchor" href="#architecture-fonctionnelle"></a>2.1. Architecture fonctionnelle</h3>
<div class="imageblock">
<div class="content">
<img src="./images/diagram-archi-fonc.png" alt="diagram archi fonc" width="1464" height="783">
</div>
<div class="title">Figure 1. Architecture fonctionnelle</div>
</div>
</div>
<div class="sect2">
<h3 id="services-webmethods"><a class="anchor" href="#services-webmethods"></a>2.2. Services webMethods</h3>
<div class="sect3">
<h4 id="routage-diffusion-messages"><a class="anchor" href="#routage-diffusion-messages"></a>2.2.1. Routage Diffusion Messages</h4>
<div class="imageblock">
<div class="content">
<img src="./images/dm-wm-services-routage.png" alt="dm wm services routage" width="1077" height="1109">
</div>
<div class="title">Figure 2. DM : Services webMethods routage</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="présentation-de-l-écran-de-simulation"><a class="anchor" href="#présentation-de-l-écran-de-simulation"></a>2.3. Présentation de l’écran de simulation</h3>
<div class="paragraph">
<p>L’IHM de simulation se présente sous la forme suivante :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Liste déroulante « <strong>Nature</strong> » permettant de choisir entre « DF », « DM », « ABT CRUD » et « ABT CHGT »</p>
</li>
<li>
<p>Liste déroulante « <strong>Mode</strong> », filtrante, avec choix possibles :</p>
<div class="ulist">
<ul>
<li>
<p>DF : « Fichier »</p>
</li>
<li>
<p>DM, ABT CRUD, ABT CHGT : « Batch » / « Temps Réel »</p>
</li>
</ul>
</div>
</li>
<li>
<p>Liste déroulante « <strong>Template</strong> » :</p>
<div class="ulist">
<ul>
<li>
<p>Choix du fichier parmi les templates du simulateur côté serveur, filtré par Nature et Canal.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Bouton <b class="button">Charger</b> pour charger le fichier choisi.</p>
</li>
<li>
<p>Bouton <b class="button">Supprimer</b> pour supprimer définitivement le fichier choisi des templates, avec confirmation. Ceci permet d&#8217;être autonome dans la gestion du patrimoine de test.</p>
</li>
<li>
<p>Zone d&#8217;aperçu éditable permettant de visualiser le futur fichier injecté, sans écrasement du template.</p>
</li>
<li>
<p>Case à cocher « <strong>Remplacer les identifiants et dates</strong> » qui permet de remplacer les identifiants par des valeurs uniques, quelque soit le contenu préalable dans l&#8217;aperçu.</p>
</li>
<li>
<p>Champ « <strong>Code testeur</strong> » utilisé dans les identifiants si remplacement activé.</p>
</li>
<li>
<p>Bouton <b class="button">Soumettre</b> qui utilise le contenu de l’aperçu comme source et applique les modifications nécessaires, conformément à la configuration du simulateur suivant qu’on ait forcé le remplacement des identifiants avant de l’injecter.</p>
<div class="ulist">
<ul>
<li>
<p>Une fois le fichier généré, le nom du fichier apparaît sur l’écran.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Champ « <strong>Nouveau template</strong> »  qui permet d&#8217;indiquer sous quel nom le template de contenu de l&#8217;aperçu devra être enregistré.</p>
</li>
<li>
<p>Bouton <b class="button">Sauvegarder</b> qui permet de sauvegarder le template.</p>
<div class="ulist">
<ul>
<li>
<p>Un message indique si la sauvegarde a fonctionné, en proposant l&#8217;écrasement si un fichier du même nom existe.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="packages-webmethods"><a class="anchor" href="#packages-webmethods"></a>3. Packages webMethods</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sgebpmdf-routage-diffusion-fichier"><a class="anchor" href="#sgebpmdf-routage-diffusion-fichier"></a>3.1. SgeBpmDf : routage Diffusion Fichier</h3>
<div class="paragraph">
<p>Le routage de la nature Diffusion Fichier est réalisé par le package webMethods <strong>SgeBpmDf</strong>.</p>
</div>
<div class="sect3">
<h4 id="services-publics"><a class="anchor" href="#services-publics"></a>3.1.1. Services publics</h4>
<div class="sect4">
<h5 id="sgebpmdf-pub-routefile"><a class="anchor" href="#sgebpmdf-pub-routefile"></a>sgeBpmDf.pub:routeFile</h5>
<div class="sect5">
<h6 id="déclenchement"><a class="anchor" href="#déclenchement"></a>Déclenchement</h6>
<div class="paragraph">
<p>Le module de routage de la Diffusion Fichier se déclenche sur réception du document <strong>sgeCommonsDocs.docs.df.bpm:StartBpmDf</strong> publié par l’IS « B2B-FIC-PE-n », lorsque le résultat des contrôles d’entrée effectués sur le fichier est OK.</p>
</div>
<div class="paragraph">
<p>Ce document contient les données d’entête du fichier à router :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/entete.png" alt="image" width="150" height="133">
</div>
</div>
<div class="paragraph">
<p>Sur réception de ce document, le trigger <strong>sgeBpmDf.triggers:routeFile</strong> est déclenché et le service associé démarre.</p>
</div>
</div>
<div class="sect5">
<h6 id="traitement"><a class="anchor" href="#traitement"></a>Traitement</h6>
<div class="paragraph">
<p>Le service <strong>sgeBpmDf.pub:routeFile</strong> réalise le routage du fichier(cf. algorithmes fonctionnels : doc [04]) :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prise en compte de la liste restrictive (*) :</p>
<div class="ulist">
<ul>
<li>
<p>appel à <a href="#genericroutingmanager-routewithrestriction">routeWithRestriction</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Prise en compte de la liste des risques :</p>
<div class="ulist">
<ul>
<li>
<p>appel à <a href="#genericroutingmanager-routewithrisques">routeWithRisques</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Prise en compte de la liste complémentaire (*) :</p>
<div class="ulist">
<ul>
<li>
<p>appel à <a href="#genericroutingmanager-routewithcomplement">routeWithComplement</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Détermination du résultat final de routage :</p>
<div class="ulist">
<ul>
<li>
<p>appel à <a href="#genericroutingmanager-getfinalresult">getFinalResult</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Stockage des demandes de routage, pour chaque destinataire (*) :</p>
<div class="ulist">
<ul>
<li>
<p>appel à <a href="#dfroutingmanager-storeroutingresult">storeRoutingResult</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Construction des données d’ARLE :</p>
<div class="ulist">
<ul>
<li>
<p>appel à <a href="#dfroutingmanager-buildendbpmdfdata">buildEndBpmDfData</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>(*) accès au cache du catalogue, cf. document</em> <em>[05]</em></p>
</div>
<div class="paragraph">
<p>En fin de traitement, le service publie le document <strong>sgeCommonsDocs.docs.df.bpm:EndBpmDf</strong>, contenant les données nécessaires à la construction de l’ARLE et des entêtes de SORTIE :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/echange_origine.png" alt="image" width="134" height="277">
</div>
</div>
</div>
<div class="sect5">
<h6 id="cycle-de-vie-du-traitement"><a class="anchor" href="#cycle-de-vie-du-traitement"></a>Cycle de vie du traitement</h6>
<div class="paragraph">
<p>Dans la base de données ESB, l’état est mis à jour au fur et à mesure du traitement dans la table ESB.DEMANDES :</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Phases</strong></th>
<th class="tableblock halign-left valign-top"><strong>Etats</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ROUTAGE</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>ENCOURS : traitement en cours</p>
</li>
<li>
<p>ERREUR : traitement en erreur</p>
</li>
<li>
<p>OK : traitement terminé, au moins un destinataire trouvé</p>
</li>
<li>
<p>KO : traitement terminé, aucun destinataire trouvé</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dans le cas OK, une ligne pour chaque destinataire est créée dans la table DEMANDE_ROUTAGES : phase INITIALISATION, état OK. Dans le cas KO, une seule ligne est créée (sans destinataire) : phase INITIALISATION, état KO.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/traitement.jpg" alt="image" width="224" height="69">
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sgebpmdm-routage-diffusion-messages"><a class="anchor" href="#sgebpmdm-routage-diffusion-messages"></a>3.2. SgeBpmDm : routage Diffusion Messages</h3>
<div class="paragraph">
<p>Le routage de la nature Diffusion Messages est réalisé par le package webMethods <strong>SgeBpmDm</strong>.</p>
</div>
<div class="sect3">
<h4 id="services-publics-2"><a class="anchor" href="#services-publics-2"></a>3.2.1. Services publics</h4>
<div class="sect4">
<h5 id="sgecommonsdocs-docs-dm-bpm-startbpmdm"><a class="anchor" href="#sgecommonsdocs-docs-dm-bpm-startbpmdm"></a>sgeCommonsDocs.docs.dm.bpm:StartBpmDm</h5>
<div class="sect5">
<h6 id="déclenchement-2"><a class="anchor" href="#déclenchement-2"></a>Déclenchement</h6>
<div class="paragraph">
<p>Le module de routage de la Diffusion Messages se déclenche sur réception du document <strong>sgeCommonsDocs.docs.dm.bpm:StartBpmDm</strong> publié par l’IS B2B-FIC lorsque le résultat des contrôles d’entrée effectués sur la demande est OK. Ce document contient les informations du message à router.</p>
</div>
<div class="paragraph">
<p><em>Cf. paragraphe "Documents WM" pour la description des documents webMethods.</em></p>
</div>
<div class="paragraph">
<p>Sur réception de ce document, le trigger <strong>sgeBpmDm.triggers:startMsg</strong> est déclenché et le service associé démarre.</p>
</div>
</div>
<div class="sect5">
<h6 id="traitement-2"><a class="anchor" href="#traitement-2"></a>Traitement</h6>
<div class="paragraph">
<p>Le traitement est réalisé en quatre étapes correspondant aux services suivants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>sgeBpmDm.pub:startMsg</strong>: appel à <a href="#dmroutingmanager-startmsg">DmRoutingManager.startMsg</a></p>
</li>
<li>
<p><strong>sgeBpmDm.pub:startRouteMsg</strong>: appel à <a href="#dmroutingmanager-startroutemsg">DmRoutingManager.startRouteMsg</a></p>
</li>
<li>
<p><strong>sgeBpmDm.pub:endRouteMsg</strong>: appel à <a href="#dmroutingmanager-endroutemsg">DmRoutingManager.endRouteMsg</a></p>
</li>
<li>
<p><strong>sgeBpmDm.pub:endMsg</strong>: appel à <a href="#dmroutingmanager-endmsg">DmRoutingManager.endMsg</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le schéma suivant représente les enchainements possibles de ces étapes :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/schema2.png" alt="image" width="631" height="326">
</div>
</div>
<div class="paragraph">
<p>En fin de traitement, le service publie le document <strong>sgeCommonsDocs.docs.dm.bpm:EndBpmDm</strong>, signalant la fin de traitement d’un message. Ce document contient les informations nécessaires au connecteur DM pour créer le message de CRF ainsi que les messages de sortie à destination de chaque consommateur.</p>
</div>
</div>
<div class="sect5">
<h6 id="cycle-de-vie-du-traitement-2"><a class="anchor" href="#cycle-de-vie-du-traitement-2"></a>Cycle de vie du traitement</h6>
<div class="paragraph">
<p>Dans la base de données ESB, l’état est mis à jour au fur et à mesure du traitement dans la table ESB.MESSAGES :</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Phases</strong></th>
<th class="tableblock halign-left valign-top"><strong>Etats</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VALIDATION</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>ENCOURS : traitement en cours</p>
</li>
<li>
<p>ATT_SNGI : traitement en attente de réponse SNGI</p>
</li>
<li>
<p>ERREUR : traitement en erreur</p>
</li>
<li>
<p>OK : traitement terminé, tous les contrôles sont OK</p>
</li>
<li>
<p>KO : traitement terminé, au moins un contrôle est KO</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/validation.jpg" alt="validation">
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ROUTAGE</p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>ENCOURS : traitement en cours</p>
</li>
<li>
<p>ATT_DCR : traitement en attente de réponse DCR</p>
</li>
<li>
<p>ERREUR : traitement en erreur</p>
</li>
<li>
<p>OK : traitement terminé, aucune erreur de routage relevée</p>
</li>
<li>
<p>OK_WARN : traitement terminé, au moins une erreur de routage relevée</p>
</li>
<li>
<p>KO : traitement terminé, aucun destinataire trouvé</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/routage.png" alt="routage">
</div>
</div>
<div class="paragraph">
<p>Dans les cas OK et OK_WARN, une ligne pour chaque destinataire est créée dans la table MESSAGE_ROUTAGES : phase INITIALISATION, état OK. Dans le cas KO, une seule ligne est créée (sans destinataire) : phase INITIALISATION, état KO.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gestion-des-anomalies"><a class="anchor" href="#gestion-des-anomalies"></a>3.3. Gestion des anomalies</h3>
<div class="paragraph">
<p>En cas d’erreur technique lors du traitement du routage :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>en BDD ESB, l’état <strong>ERREUR</strong> est positionné sur la phase en cours :</p>
<div class="ulist">
<ul>
<li>
<p>pour DF : tables DEMANDES et/ou DEMANDE_ROUTAGES</p>
</li>
<li>
<p>pour DM : tables MESSAGES et/ou MESSAGE_ROUTAGES</p>
</li>
</ul>
</div>
</li>
<li>
<p>un log d’avancement <strong>logERREUR</strong> est émis vers le suivi pour signaler l’erreur.</p>
</li>
<li>
<p>une anomalie technique est générée et stockée dans le gestionnaire des anomalies. Si l’erreur est temporaire (exemple : problème d’accès base de données), l’anomalie peut être rejouée et le traitement reprend alors. Si l’erreur est définitive (exemple : donnée incorrecte), l’anomalie ne peut pas être rejouée.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="documents-wm"><a class="anchor" href="#documents-wm"></a>3.4. Documents WM</h3>
<div class="sect3">
<h4 id="sgecommonsdocs-docs-dm-bpm-data-non-publiable"><a class="anchor" href="#sgecommonsdocs-docs-dm-bpm-data-non-publiable"></a>3.4.1. sgeCommonsDocs.docs.dm.bpm:Data (non publiable)</h4>
<div class="paragraph">
<p>Ce document contient la structure commune des données partagées par tous les documents webMethods du BPM DM :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Message</p>
<div class="ulist">
<ul>
<li>
<p>Identifiant</p>
</li>
<li>
<p>Horodatage</p>
</li>
<li>
<p>Type</p>
</li>
<li>
<p>CleSelectVersion</p>
</li>
<li>
<p>RefConversation</p>
</li>
<li>
<p>Individu</p>
</li>
<li>
<p>Fonction</p>
</li>
</ul>
</div>
</li>
<li>
<p>Service : Reference / Version</p>
</li>
<li>
<p>Routage</p>
<div class="ulist">
<ul>
<li>
<p>Risques : Identifiant[]</p>
</li>
<li>
<p>Restriction[] : Identifiant / Type</p>
</li>
<li>
<p>Complement[] : Identifiant / Type</p>
</li>
</ul>
</div>
</li>
<li>
<p>Filtrage[] : Key / Value</p>
</li>
<li>
<p>Rattachement[] : Identifiant / Etat / DateCloture</p>
</li>
<li>
<p>IdentiteIndividu &#8658; Bloc IdentiteIndividu complet (cf. Contrat d’Interface DM)</p>
</li>
<li>
<p>Producteur</p>
<div class="ulist">
<ul>
<li>
<p>Identifiant/ Type / Libelle</p>
</li>
<li>
<p>Resultat</p>
<div class="ulist">
<ul>
<li>
<p>Statut</p>
</li>
<li>
<p>Complement[] : Code / Libelle</p>
</li>
</ul>
</div>
</li>
<li>
<p>Option[] : Key / Value</p>
</li>
</ul>
</div>
</li>
<li>
<p>Consommateur[]</p>
<div class="ulist">
<ul>
<li>
<p>IdDemandeRoutage</p>
</li>
<li>
<p>Identifiant/ Type / Libelle</p>
</li>
<li>
<p>FrequenceIndividu / CleRegroupement / PrioRegroupement</p>
</li>
<li>
<p>Enrichissement[] : Key / Value</p>
</li>
<li>
<p>Resultat</p>
<div class="ulist">
<ul>
<li>
<p>Statut</p>
</li>
<li>
<p>Complement[] : Code / Libelle</p>
</li>
</ul>
</div>
</li>
<li>
<p>Option[] : Key / Value</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Selon les étapes, tous les champs ne sont pas forcément renseignés. Les données sont enrichies au fur et à mesure du traitement.</p>
</div>
<div class="paragraph">
<p>Cette structure est utilisée par les documents suivants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sgeCommonsDocs.docs.dm.bpm:StartBpmDm</p>
</li>
<li>
<p>sgeCommonsDocs.docs.dm.bpm:StartRouteMsg</p>
</li>
<li>
<p>sgeCommonsDocs.docs.dm.bpm:EndRouteMsg</p>
</li>
<li>
<p>sgeCommonsDocs.docs.dm.bpm:EndMsg</p>
</li>
<li>
<p>sgeCommonsDocs.docs.dm.bpm:EndBpmDm</p>
</li>
<li>
<p>sgeCommonsDocs.docs.dm.bpm:CallSNGI</p>
</li>
<li>
<p>sgeCommonsDocs.docs.dm.bpm:CallDCR</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces documents ont tous la même structure :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IdDemande : identifiant de la demande d’entrée (champ Identifiant de la table DEMANDES)</p>
</li>
<li>
<p>IdMessage : identifiant du message d’entrée (champ Identifiant de la table MESSAGES)</p>
</li>
<li>
<p>IdMessageTech : identifiant technique du message (champ Id de la tables MESSAGES)</p>
</li>
<li>
<p>Entete :</p>
<div class="ulist">
<ul>
<li>
<p>structure sgeCommonsDocs.docs.dm.bpm:Data</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Note : c&#8217;est « IdMessageTech » qui est utilisé pour retrouver le message en BDD (table MESSAGES).</strong></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sgebpmcommons"><a class="anchor" href="#sgebpmcommons"></a>3.5. SgeBpmCommons</h3>
<div class="paragraph">
<p>Les services webMethods de routage sont regroupés dans le package <strong>SgeBpmCommons</strong>.</p>
</div>
<div class="sect3">
<h4 id="services-publics-3"><a class="anchor" href="#services-publics-3"></a>3.5.1. Services publics</h4>
<div class="sect4">
<h5 id="sgebpmcommons-sched-reinitcacherfo"><a class="anchor" href="#sgebpmcommons-sched-reinitcacherfo"></a>sgeBpmCommons.sched:reinitCacheRFO</h5>
<div class="paragraph">
<p>Ce service est schédulé à intervalles réguliers (tous les jours). Il réalise la réinitialisation du cache RFO après récupération des risques et domaines, via appel de la méthode JAVA <a href="#cacherfo-initrisquelistfromrfo">initRisqueListFromRFO</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jars"><a class="anchor" href="#jars"></a>4. Jars</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les méthodes JAVA de routage sont regroupées dans le jar du package <strong>SgeBpmCommons</strong>.</p>
</div>
<div class="sect2">
<h3 id="cacherfo-initrisquelistfromrfo"><a class="anchor" href="#cacherfo-initrisquelistfromrfo"></a>4.1. CacheRFO.initRisqueListFromRFO</h3>
<div class="paragraph">
<p>Ce service réalise l’appel, en remoteInvoke sur l’IS A2A (sur le premier nœud disponible, via utilisation de la méthode remoteInvokeMultiNodes), du service suivant du connecteur RFO :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sgeConnectorRFO.pub:getAllRisquesRDomainesValides</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il est utilisé :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>soit par le service de consultation du cache, lors de la première consultation;</p>
</li>
<li>
<p>soit par le service de réinitialisation du cache, à intervalles réguliers (tous les jours).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cacherfo-getrisquelistfromrfo"><a class="anchor" href="#cacherfo-getrisquelistfromrfo"></a>4.2. CacheRFO.getRisqueListFromRFO</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Entrées</strong></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>N/A</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Sorties</strong></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>ConcurrentMap&lt;String, List&lt;String&gt;&gt; risqueListFromRFO =</strong> liste des risques issus du RFO et des domaines associés à chacun de ces risques<strong>.</strong></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Ce service, commun aux natures d’échange DF et DM, retourne la liste des risques et domaines du RFO conservés en cache dans une ConcurrentHashMap. Si la liste est nulle ou vide, la méthode JAVA <a href="#cacherfo-initrisquelistfromrfo">initRisqueListFromRFO</a> est appelée pour l’initialiser avant de la retourner. Si la liste est vide suite à cette initialisation, une exception est levée.</p>
</div>
</div>
<div class="sect2">
<h3 id="genericroutingmanager-routewithrestriction"><a class="anchor" href="#genericroutingmanager-routewithrestriction"></a>4.3. GenericRoutingManager.routeWithRestriction</h3>
<div class="paragraph">
<p>Ce service, commun aux natures d’échange DF et DM, implémente l’algorithme fonctionnel de prise en compte de la liste restrictive, décrit dans le document [04]. Selon la nature d’échange, la liste restrictive donnée en paramètre du service est différente (récupérée au niveau du fichier pour DF, ou bien récupérée au niveau du message pour DM).</p>
</div>
</div>
<div class="sect2">
<h3 id="genericroutingmanager-routewithrisques"><a class="anchor" href="#genericroutingmanager-routewithrisques"></a>4.4. GenericRoutingManager.routeWithRisques</h3>
<div class="paragraph">
<p>Ce service, commun aux natures d’échange DF et DM, implémente l’algorithme fonctionnel de prise en compte de la liste des risques, décrit dans le document [04]. Selon la nature d’échange, la liste des risques donnée en paramètre du service est différente (récupérée au niveau du fichier pour DF, ou bien récupérée au niveau du message pour DM).</p>
</div>
</div>
<div class="sect2">
<h3 id="genericroutingmanager-routewithcomplement"><a class="anchor" href="#genericroutingmanager-routewithcomplement"></a>4.5. GenericRoutingManager.routeWithComplement</h3>
<div class="paragraph">
<p>Ce service, commun aux natures d’échange DF et DM, implémente l’algorithme fonctionnel de prise en compte de la liste complémentaire, décrit dans le document [04]. Selon la nature d’échange, la liste complémentaire donnée en paramètre du service est différente (récupérée au niveau du fichier pour DF, ou bien récupérée au niveau du message pour DM).</p>
</div>
</div>
<div class="sect2">
<h3 id="genericroutingmanager-routewithabonnement"><a class="anchor" href="#genericroutingmanager-routewithabonnement"></a>4.6. GenericRoutingManager.routeWithAbonnement</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DM, implémente l’algorithme fonctionnel de prise en compte des abonnements individus, décrit dans les documents [06] et [07]. L’algorithme est identique quel que soit le mode de communication d’entrée utilisé (batch ou temps réel).</p>
</div>
</div>
<div class="sect2">
<h3 id="genericroutingmanager-routewithdcr"><a class="anchor" href="#genericroutingmanager-routewithdcr"></a>4.7. GenericRoutingManager.routeWithDCR</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DM, implémente l’algorithme fonctionnel de prise en compte des DCR, décrit dans les documents [06] et [07]. L’algorithme est identique quel que soit le mode de communication d’entrée utilisé (batch ou temps réel).</p>
</div>
</div>
<div class="sect2">
<h3 id="genericroutingmanager-getfinalresult"><a class="anchor" href="#genericroutingmanager-getfinalresult"></a>4.8. GenericRoutingManager.getFinalResult</h3>
<div class="paragraph">
<p>Ce service, commun aux natures d’échange DF et DM, implémente l’algorithme fonctionnel de détermination du résultat final de routage, décrit dans le document [04].</p>
</div>
</div>
<div class="sect2">
<h3 id="dfroutingmanager-storeroutingresult"><a class="anchor" href="#dfroutingmanager-storeroutingresult"></a>4.9. DfRoutingManager.storeRoutingResult</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DF, permet de stocker en base de données les demandes de routage pour le fichier courant :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Autant de demandes de routage que de consommateurs « OK »</p>
</li>
<li>
<p>Ou bien, si aucun consommateur « OK », une ligne « demande de routage KO »</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="entrées-sorties"><a class="anchor" href="#entrées-sorties"></a>4.9.1. Entrées/Sorties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Entrées</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Demande demande =</strong> demande (table ESB.DEMANDES) concernée par le routage</p>
</li>
<li>
<p><strong>RoutingResult routingResult =</strong> résultat de routage</p>
</li>
<li>
<p><strong>String serviceRef =</strong> référence du service d’échange</p>
</li>
<li>
<p><strong>String fonction =</strong> fonction de la demande d’échange courante</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sorties</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Map&lt;String, String&gt; demandeRoutageIdList =</strong> liste des identifiants BDD de la table DEMANDE_ROUTAGES</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="algorithme"><a class="anchor" href="#algorithme"></a>4.9.2. Algorithme</h4>
<div class="paragraph">
<p>Si fonction!= 53 (pas de stockage dans le cas « 53 » = « test par le producteur ») :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pour chaque consommateur dont le résultat de routage est OK :</p>
<div class="ulist">
<ul>
<li>
<p>Insertion d’un tuple dans la table DEMANDE_ROUTAGES pour la demande courante avec :</p>
<div class="ulist">
<ul>
<li>
<p>Référence du service</p>
</li>
<li>
<p>Identifiant du consommateur</p>
</li>
<li>
<p>Nature = « DiffusionFichier » / Phase = « DF_SORTIE »</p>
</li>
<li>
<p>Phase = « INITIALISATION » / Etat = « OK »</p>
</li>
</ul>
</div>
</li>
<li>
<p>Ajout de l’identifiant du tuple au résultat <strong>demandeRoutageIdList</strong>, pour le consommateur courant</p>
</li>
</ul>
</div>
</li>
<li>
<p>Si aucun consommateur OK :</p>
<div class="ulist">
<ul>
<li>
<p>Insertion d’un tuple dans la table DEMANDE_ROUTAGES pour la demande courante avec :</p>
<div class="ulist">
<ul>
<li>
<p>Référence du service</p>
</li>
<li>
<p>&lt;pas d’identifiant consommateur&gt;</p>
</li>
<li>
<p>Nature = « DiffusionFichier » / Phase = « DF_SORTIE »</p>
</li>
<li>
<p>Phase = « INITIALISATION » / Etat = « KO »</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dfroutingmanager-buildendbpmdfdata"><a class="anchor" href="#dfroutingmanager-buildendbpmdfdata"></a>4.10. DfRoutingManager.buildEndBpmDfData</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DF, permet de construire le document EndBpmDf contenant :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les données d’ARLE à remettre au producteur (décrit dans le document [04])</p>
</li>
<li>
<p>les options d’envoi pour la construction des fichiers DF_ARLE et DF_SORTIE</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="entrées-sorties-2"><a class="anchor" href="#entrées-sorties-2"></a>4.10.1. Entrées/Sorties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Entrées</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>RoutingResult routingResult =</strong> résultat de routage</p>
</li>
<li>
<p><strong>String serviceRef =</strong> référence du service d’échange</p>
</li>
<li>
<p><strong>String echangeId =</strong> identifiant de la demande d’échange courante</p>
</li>
<li>
<p><strong>String producteurId =</strong> identifiant du producteur de l’échange courant</p>
</li>
<li>
<p><strong>String fonction =</strong> fonction de la demande d’échange courante</p>
</li>
<li>
<p><strong>Map&lt;String, String&gt; demandeRoutageIdList =</strong> liste des identifiants BDD de la table DEMANDE_ROUTAGES</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sorties</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>IData EndBpmDf =</strong> contenu du document EndBpmDf à publier</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="algorithme-2"><a class="anchor" href="#algorithme-2"></a>4.10.2. Algorithme</h4>
<div class="paragraph">
<p>Construction du document EndBpmDf avec les valeurs suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>EchangeOrigine/Identifiant = &lt;echangeId&gt;</p>
</li>
<li>
<p>ARLE/Statut = « A » si résultat globalde routage OK, « R » sinon</p>
</li>
<li>
<p>ARLE/Complement= Codes et Libelles du résultat global de routage</p>
</li>
<li>
<p>ARLE/Option :</p>
<div class="ulist">
<ul>
<li>
<p>Key=SendARLE &#8658; Value= « false » si fonction = 54, « true » sinon</p>
</li>
<li>
<p>Key=ListeConsommateurs &#8658; Value= « true » si option producteur « communiquer la liste des destinataires » = OUI, « false » sinon</p>
</li>
</ul>
</div>
</li>
<li>
<p>Pour chaque consommateurdu résultat de routage :</p>
<div class="ulist">
<ul>
<li>
<p>Consommateur/Identifiant = identifiant RFO du consommateur</p>
</li>
<li>
<p>Consommateur/IdDemandeRoutage = si statut OK, identifiant du tuple sauvegardé dans la table DEMANDE_ROUTAGES pour ce consommateur, champ absent sinon</p>
</li>
<li>
<p>Consommateur/Type = « RFO »</p>
</li>
<li>
<p>Consommateur/Libelle = libellé du consommateur issu du catalogue</p>
</li>
<li>
<p>Consommateur/Resultat/Statut = résultat du consommateur (« OK » ou « KO »)</p>
</li>
<li>
<p>Consommateur/Resultat/Complement[]= Codes et Libelles du consommateur</p>
</li>
<li>
<p>Consommateur/Option :</p>
<div class="ulist">
<ul>
<li>
<p>Key=SendSORTIE &#8658; Value= « false » si fonction = 53, « true » sinon</p>
</li>
<li>
<p>Key=ListeConsommateurs &#8658; Value=« true » si option service et option consommateur « communiquer la liste des destinataires » = OUI, « false » sinon</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dmroutingmanager-startmsg"><a class="anchor" href="#dmroutingmanager-startmsg"></a>4.11. DmRoutingManager.startMsg</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DM, est la première étape du processus de traitement d’un message, et consiste, pour le message courant, à contrôler les données puis à déclencher l’appel au SNGI si nécessaire ou bien à déclencher l’étape suivante du processus.</p>
</div>
<div class="paragraph">
<p>La liste détaillée des contrôles et codes d’erreur associés est présente dans les fichiers [03] et [08]. En cas d’échec de l’un des contrôles, les contrôles se poursuivent afin de remonter toutes les erreurs relevées.</p>
</div>
<div class="sect3">
<h4 id="déclenchement-3"><a class="anchor" href="#déclenchement-3"></a>4.11.1. Déclenchement</h4>
<div class="ulist">
<ul>
<li>
<p>Sur réception d’un document <strong>StartBpmDm</strong> en provenance du connecteur DM</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="entrées-sorties-3"><a class="anchor" href="#entrées-sorties-3"></a>4.11.2. Entrées/Sorties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Entrées</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc StartBpmDm</strong> contenant les données du message à contrôler</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sorties</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc CallSNGI ou StartRouteMsgou EndMsg</strong> contenant les données du message enrichies avec :</p>
<div class="ulist">
<ul>
<li>
<p>résultat courant des contrôles (statut et codes/libellés)</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="algorithme-3"><a class="anchor" href="#algorithme-3"></a>4.11.3. Algorithme</h4>
<div class="paragraph">
<p>Contrôles d’entrée</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mise à jour BDD MESSAGES : Phase = <strong>VALIDATION</strong> / Etat =<strong>ENCOURS</strong></p>
</li>
<li>
<p>Contrôle de l’entête du message</p>
</li>
<li>
<p>Contrôle des données métier du message récupérées en BDD MESSAGES, selon options</p>
</li>
<li>
<p>Contrôle des balises SNGI du message, selon options SNGI et DCR</p>
</li>
<li>
<p>Construction des données à publier :</p>
<div class="ulist">
<ul>
<li>
<p>Données reçues en entrée du service + résultat courant des contrôles</p>
</li>
</ul>
</div>
</li>
<li>
<p>Si au moins un contrôle est KO :</p>
<div class="ulist">
<ul>
<li>
<p>Mise à jour BDD MESSAGES : Phase =<strong>VALIDATION</strong> / Etat =<strong>KO</strong></p>
</li>
<li>
<p>Publication du document <strong>EndMsg</strong> pour déclencher l’étape de fin de traitement</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sinon :</p>
<div class="ulist">
<ul>
<li>
<p>Si un appel au SNGI est nécessaire :</p>
<div class="ulist">
<ul>
<li>
<p>Mise à jour BDD MESSAGES : Phase =<strong>VALIDATION</strong> / Etat =<strong>ATT_SNGI</strong></p>
</li>
<li>
<p>Publication du document <strong>CallSNGI</strong> vers l’IS A2A pour déclencher l’appel au SNGI</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sinon :</p>
<div class="ulist">
<ul>
<li>
<p>Mise à jour BDD MESSAGES : Phase =<strong>VALIDATION</strong> / Etat =<strong>OK</strong></p>
</li>
<li>
<p>Publication du document <strong>StartRouteMsg</strong> pour déclencher l’étape de routage</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dmroutingmanager-startroutemsg"><a class="anchor" href="#dmroutingmanager-startroutemsg"></a>4.12. DmRoutingManager.startRouteMsg</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DM, est la deuxième étape du processus de traitement d’un message, et consiste, pour le message courant, à contrôler le résultat SNGI si un appel SNGI a eu lieu, à démarrer la détermination des destinataires, puis à déclencher l’appel au DCR si nécessaire ou bien à déclencher l’étape suivante du processus.</p>
</div>
<div class="sect3">
<h4 id="déclenchement-4"><a class="anchor" href="#déclenchement-4"></a>4.12.1. Déclenchement</h4>
<div class="ulist">
<ul>
<li>
<p>Sur réception d’un document <strong>StartRouteMsg</strong> en provenance :</p>
<div class="ulist">
<ul>
<li>
<p>de l’étape startMsg du processus (si pas d’appel SNGI)</p>
</li>
<li>
<p>ou du connecteur SNGI (réponse SNGI)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="entrées-sorties-4"><a class="anchor" href="#entrées-sorties-4"></a>4.12.2. Entrées/Sorties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Entrées</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc StartRouteMsg</strong> contenant les données du message enrichies avec :</p>
<div class="ulist">
<ul>
<li>
<p>résultat courant des contrôles (statut et codes/libellés)</p>
</li>
<li>
<p>résultat SNGI (si appel SNGI)</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sorties</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc EndMsg ou CallDCR ou EndRouteMsg</strong>contenant les données du message enrichies avec :</p>
<div class="ulist">
<ul>
<li>
<p>résultat final des contrôles (statut et codes/libellés), y compris contrôle SNGI</p>
</li>
<li>
<p>résultat courant du routage, par consommateur (statut et codes/libellés)</p>
</li>
<li>
<p>données issues du routage par abonnement individu (enrichissement, regroupement…)</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="algorithme-4"><a class="anchor" href="#algorithme-4"></a>4.12.3. Algorithme</h4>
<div class="paragraph">
<p><em>Si déclenché par une réponse SNGI, finalisation des contrôles d’entrée (état courant = ATT_SNGI) :</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Contrôle de la réponse SNGI</p>
</li>
<li>
<p>Construction des données à publier :</p>
<div class="ulist">
<ul>
<li>
<p>Données reçues en entrée du service + résultat final des contrôles</p>
</li>
<li>
<p>Réponse et résultat SNGI</p>
</li>
</ul>
</div>
</li>
<li>
<p>Mise à jour BDD MESSAGES : Phase <strong>VALIDATION</strong> / Etat = <strong>OK ou KO</strong></p>
</li>
<li>
<p>Si au moins un contrôle est KO :</p>
<div class="ulist">
<ul>
<li>
<p>Publication du document <strong>EndMsg</strong> pour déclencher l’étape de fin de traitement</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Détermination des destinataires</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si tous les contrôles sont OK:</p>
<div class="ulist">
<ul>
<li>
<p>Mise à jour BDD MESSAGES: Phase =<strong>ROUTAGE</strong> / Etat =<strong>ENCOURS</strong></p>
</li>
<li>
<p>Prise en compte de la liste restrictive (<em>1</em>): appel à <a href="#genericroutingmanager-routewithrestriction">routeWithRestriction</a></p>
</li>
<li>
<p>Prise en compte de la liste des risques(<em>2</em>) : appel à <a href="#genericroutingmanager-routewithrisques">routeWithRisques</a></p>
</li>
<li>
<p>Prise en compte des abonnements individus(<em>3</em>) : appel à <a href="#genericroutingmanager-routewithabonnement">routeWithAbonnement</a></p>
</li>
<li>
<p>Construction des données à publier:</p>
<div class="ulist">
<ul>
<li>
<p>Données reçues en entrée du service + résultat courant du routage</p>
</li>
<li>
<p>Si abonnementindividu :</p>
<div class="ulist">
<ul>
<li>
<p>clés/valeurs d’enrichissement</p>
</li>
<li>
<p>identifiant et priorité de regroupement</p>
</li>
<li>
<p>fréquence du message</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Si un appel au DCR est nécessaire:</p>
<div class="ulist">
<ul>
<li>
<p>Mise à jour BDD MESSAGES: Phase =<strong>ROUTAGE</strong> / Etat =<strong>ATT_DCR</strong></p>
</li>
<li>
<p>Publication du document <strong>CallDCR</strong> vers l’IS A2A pour déclencher l’appel au DCR</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sinon:</p>
<div class="ulist">
<ul>
<li>
<p>Publication du document <strong>EndRouteMsg</strong> pour déclencher l’étape de fin de routage</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>(1) accès au cache du catalogue, cf. document</em> [05]</p>
</div>
<div class="paragraph">
<p><em>(2) accès au cache RFO</em></p>
</div>
<div class="paragraph">
<p><em>(3) accès direct au référentiel des abonnements individus, cf. document</em> <em>[05]</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dmroutingmanager-endroutemsg"><a class="anchor" href="#dmroutingmanager-endroutemsg"></a>4.13. DmRoutingManager.endRouteMsg</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DM, est la troisième étape du processus de traitement d’un message, et consiste, pour le message courant, à contrôler le résultat DCR si un appel DCR a eu lieu, à finaliser la détermination des destinataires, puis à déclencher l’étape suivante du processus.</p>
</div>
<div class="sect3">
<h4 id="déclenchement-5"><a class="anchor" href="#déclenchement-5"></a>4.13.1. Déclenchement</h4>
<div class="ulist">
<ul>
<li>
<p>Sur réception d’un document <strong>EndRouteMsg</strong> en provenance :</p>
<div class="ulist">
<ul>
<li>
<p>de l’étape startRouteMsg du processus (si pas d’appel DCR)</p>
</li>
<li>
<p>ou du connecteur DCR (réponse DCR)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="entrées-sorties-5"><a class="anchor" href="#entrées-sorties-5"></a>4.13.2. Entrées/Sorties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Entrées</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc EndRouteMsg</strong>contenant les données du message enrichies avec :</p>
<div class="ulist">
<ul>
<li>
<p>résultat final des contrôles (statut et codes/libellés), y compris contrôle SNGI</p>
</li>
<li>
<p>résultat courant du routage, par consommateur (statut et codes/libellés)</p>
</li>
<li>
<p>données issues du routage par abonnement individu (enrichissement, regroupement…)</p>
</li>
<li>
<p>résultat DCR (si appel DCR)</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sorties</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc EndMsg</strong> contenant les données du message enrichies avec :</p>
<div class="ulist">
<ul>
<li>
<p>résultat final du routage, par consommateur (statut et codes/libellés)</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="algorithme-5"><a class="anchor" href="#algorithme-5"></a>4.13.3. Algorithme</h4>
<div class="paragraph">
<p><em>Finalisation de la détermination des destinataires</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si déclenché par une réponse DCR (état courant = ATT_DCR) :</p>
<div class="ulist">
<ul>
<li>
<p>Prise en compte des DCR : appel à <a href="#genericroutingmanager-routewithdcr">routewithdcr</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Prise en compte de la liste complémentaire(*) : appel à <a href="#genericroutingmanager-routewithcomplement">routeWithComplement</a></p>
</li>
<li>
<p>Détermination du résultat final de routage : appel à <a href="#genericroutingmanager-getfinalresult">getFinalResult</a></p>
</li>
<li>
<p>Construction des données à publier :</p>
<div class="ulist">
<ul>
<li>
<p>Données reçues en entrée du service + résultat final du routage</p>
</li>
</ul>
</div>
</li>
<li>
<p>Publication du document <strong>EndMsg</strong> pour déclencher l’étape de fin de traitement</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>(*) accès au cache du catalogue, cf. document</em> [05]</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dmroutingmanager-endmsg"><a class="anchor" href="#dmroutingmanager-endmsg"></a>4.14. DmRoutingManager.endMsg</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DM, est la dernière étape du processus de traitement d’un message, et consiste, pour le message courant, à stocker les demandes de routage en base de données, puis à signaler la fin de traitement du message au connecteur DM en lui transmettant les informations nécessaires à la création des messages CRF et des messages de SORTIE.</p>
</div>
<div class="sect3">
<h4 id="déclenchement-6"><a class="anchor" href="#déclenchement-6"></a>4.14.1. Déclenchement</h4>
<div class="ulist">
<ul>
<li>
<p>Sur réception d’un document <strong>EndMsg</strong> en provenance :</p>
<div class="ulist">
<ul>
<li>
<p>de l’étape startMsg du processus (si contrôle KO)</p>
</li>
<li>
<p>ou de l’étape startRouteMsg du processus (si contrôle KO)</p>
</li>
<li>
<p>ou de l’étape endRouteMsg du processus</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="entrées-sorties-6"><a class="anchor" href="#entrées-sorties-6"></a>4.14.2. Entrées/Sorties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Entrées</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc EndRouteMsg</strong>contenant les données du message enrichies avec :</p>
<div class="ulist">
<ul>
<li>
<p>résultat final des contrôles (statut et codes/libellés), y compris contrôle SNGI</p>
</li>
<li>
<p>résultat final du routage, par consommateur (statut et codes/libellés)</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sorties</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc EndBpmDm</strong> contenant les données du message enrichies avec :</p>
<div class="ulist">
<ul>
<li>
<p>options d’envoi vers le producteur et les consommateurs du message</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="algorithme-6"><a class="anchor" href="#algorithme-6"></a>4.14.3. Algorithme</h4>
<div class="paragraph">
<p><em>Finalisation des contrôles d’entrée</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si Phase <strong>ROUTAGE</strong>, stockage des demandes de routage, pour chaque destinataire : appel à <a href="#dmroutingmanager-storeroutingresult">storeRoutingResult</a></p>
</li>
<li>
<p>Mise à jour BDD MESSAGES : Phase <strong>ROUTAGE</strong> / Etat = <strong>OK, OK_WARN ou KO</strong></p>
</li>
<li>
<p>Construction des données à publier vers le connecteur : appel à <a href="#dmroutingmanager-buildendbpmdmdata">buildEndBpmDmData</a></p>
</li>
<li>
<p>Publication du document <strong>EndBpmDm</strong> pour signaler la fin du processsus</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dmroutingmanager-storeroutingresult"><a class="anchor" href="#dmroutingmanager-storeroutingresult"></a>4.15. DmRoutingManager.storeRoutingResult</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DM, permet de stocker en base de données les demandes de routage pour le message courant :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Autant de demandes de routage que de consommateurs « OK »</p>
</li>
<li>
<p>Ou bien, si aucun consommateur « OK », une ligne « demande de routage KO »</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="entrées-sorties-7"><a class="anchor" href="#entrées-sorties-7"></a>4.15.1. Entrées/Sorties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Entrées</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>String id =</strong> identifiant du message concerné par le routage (table ESB.MESSAGES)</p>
</li>
<li>
<p><strong>RoutingResult routingResult =</strong> résultat de routage</p>
</li>
<li>
<p><strong>String serviceRef =</strong> référence du service d’échange</p>
</li>
<li>
<p><strong>String fonction =</strong> fonction de la demande d’échange courante</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sorties</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Map&lt;String, String&gt; messageRoutageIdList =</strong> liste des identifiants BDD de la table MESSAGE_ROUTAGES</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="algorithme-7"><a class="anchor" href="#algorithme-7"></a>4.15.2. Algorithme</h4>
<div class="paragraph">
<p><em>Enrichissement et stockage du message à router</em></p>
</div>
<div class="paragraph">
<p>Si fonction!= 53 (pas de stockage dans le cas « 53 » = « test par le producteur ») :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pour chaque consommateur dont le résultat de routage est OK :</p>
<div class="ulist">
<ul>
<li>
<p>Création d’un tuple MESSAGE_ROUTAGES en BDD pour le message courant avec :</p>
<div class="ulist">
<ul>
<li>
<p>Référence du service</p>
</li>
<li>
<p>Identifiant du consommateur</p>
</li>
<li>
<p>Nature = « DiffusionMessages » / Phase = « DM_SORTIE »</p>
</li>
<li>
<p>Phase = « INITIALISATION » / Etat = « OK »</p>
</li>
<li>
<p>Identifiant de regroupement = si abonnement, issu de l’abonnement, sinon, du service</p>
</li>
<li>
<p>Priorité de regroupement = si abonnement, issu de l’abonnement</p>
</li>
<li>
<p>Date d’envoi prévue = si abonnement, calculé avec fréquence abonnement individu</p>
</li>
</ul>
</div>
</li>
<li>
<p>Ajout de l’identifiant du tuple au résultat <strong>messageRoutageIdList</strong>, pour le consommateur courant</p>
</li>
</ul>
</div>
</li>
<li>
<p>Si aucun consommateur OK :</p>
<div class="ulist">
<ul>
<li>
<p>Création d’un tuple MESSAGE_ROUTAGES en BDD pour le message courant avec :</p>
<div class="ulist">
<ul>
<li>
<p>Référence du service</p>
</li>
<li>
<p>&lt;pas d’identifiant consommateur&gt;</p>
</li>
<li>
<p>Nature = « DiffusionMessages » / Phase = «DM_SORTIE»</p>
</li>
<li>
<p>Phase = « INITIALISATION » / Etat = « KO »</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dmroutingmanager-buildendbpmdmdata"><a class="anchor" href="#dmroutingmanager-buildendbpmdmdata"></a>4.16. DmRoutingManager.buildEndBpmDmData</h3>
<div class="paragraph">
<p>Ce service, spécifique à la nature d’échange DM, permet de construire le document EndBpmDm contenant :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les données de CRF à remettre au producteur (décrit dans le document [03])</p>
</li>
<li>
<p>les options d’envoi pour la construction des messages de CRF, ainsi que des messages de sortie à destination de chaque consommateur.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="entrées-sorties-8"><a class="anchor" href="#entrées-sorties-8"></a>4.16.1. Entrées/Sorties</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Entrées</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>Doc enteteEndMsg</strong> contenant les données de l&#8217;entete du message</p>
</li>
<li>
<p><strong>String serviceRef =</strong> référence du service d’échange</p>
</li>
<li>
<p><strong>String producteurId =</strong> identifiant du producteur de l’échange courant</p>
</li>
<li>
<p><strong>String fonction =</strong> fonction de la demande d’échange courante</p>
</li>
<li>
<p><strong>Map&lt;String, String&gt; messageRoutageIdList =</strong> liste des identifiants BDD de la table MESSAGE_ROUTAGES</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sorties</p></th>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p><strong>IData EndBpmDm =</strong> contenu du document EndBpmDm à publier</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="algorithme-8"><a class="anchor" href="#algorithme-8"></a>4.16.2. Algorithme</h4>
<div class="paragraph">
<p>Construction du document EndBpmDm avec les valeurs suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Données du message d’entrée (hors listes de routage, clés et valeurs de filtrage)</p>
</li>
<li>
<p>Données d’enrichissement du message :</p>
<div class="ulist">
<ul>
<li>
<p>Clés et valeurs d’enrichissement</p>
</li>
<li>
<p>Résultat et réponse SNGI, si un appel SNGI a eu lieu</p>
</li>
</ul>
</div>
</li>
<li>
<p>Données producteur :</p>
<div class="ulist">
<ul>
<li>
<p>Resultat/Statut = « OK », « OK avec signalement » ou « KO »</p>
</li>
<li>
<p>Resultat/Complement[] = Codes et Libellés de validation et de routage</p>
</li>
<li>
<p>Options :</p>
<div class="ulist">
<ul>
<li>
<p>Key=Send &#8658; Value=« false » si fonction = 54, « true » sinon</p>
</li>
<li>
<p>Key=Consommateurs &#8658; Value=« true » si option producteur « communiquer la liste des destinataires » = OUI, « false » sinon</p>
</li>
<li>
<p>Key=SNGI &#8658; Value=« true » si option producteur « communiquer le résultat d’identification SNGI » = OUI, « false » sinon</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><em>Pour chaque consommateur,</em></p>
<div class="ulist">
<ul>
<li>
<p>Données consommateur :</p>
<div class="ulist">
<ul>
<li>
<p>Identifiant = identifiant RFO du consommateur</p>
</li>
<li>
<p>IdDemandeRoutage = si statut OK, identifiant du tuple sauvegardé dans la table MESSAGE_ROUTAGES pour ce consommateur, champ absent sinon</p>
</li>
<li>
<p>Type = « RFO »</p>
</li>
<li>
<p>Libelle = libellé du consommateur issu du catalogue</p>
</li>
<li>
<p>Resultat/Statut = résultat du consommateur (« OK » ou « KO »)</p>
</li>
<li>
<p>Resultat/Complement[]= Codes et Libelles du consommateur</p>
</li>
<li>
<p>Options :</p>
<div class="ulist">
<ul>
<li>
<p>Key=Send &#8658; Value=« false » si fonction = 53, « true » sinon</p>
</li>
<li>
<p>Key=Consommateurs &#8658; Value=« true » si option service et option consommateur « communiquer la liste des destinataires » = OUI, « false » sinon</p>
</li>
<li>
<p>Key=SNGI &#8658; Value=« true » si option consommateur « communiquer le résultat d’identification SNGI » = OUI, « false » sinon</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-12-18 17:35:49 UTC
</div>
</div>
<link rel="stylesheet" href="highlight/styles/gruvbox-dark.min.css">
<script src="highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>