<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<link rel="shortcut icon" type="image/png" href="themes/favicon-white.png">
<title>Elastic Suite Configuration Details</title>
<link rel="stylesheet" href="themes/css/html-zenika.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

      <link rel="stylesheet" href="lib/c3.v0-6-11.min.css">
      <script src="lib/d3.v5-7-0.min.js" charset="utf-8"></script>
      <script src="lib/c3.v0-6-11.min.js"></script>
    
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Elastic Suite Configuration Details</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#elastic-servers-configuration">1. Elastic servers configuration</a>
<ul class="sectlevel2">
<li><a href="#initialize-vm">1.1. Initialize VM</a></li>
<li><a href="#install-docker">1.2. Install Docker</a>
<ul class="sectlevel3">
<li><a href="#define-nexus3-as-the-docker-registry">1.2.1. Define Nexus3 as the Docker registry</a></li>
</ul>
</li>
<li><a href="#setup-a-dockerized-oracle12c-database">1.3. Setup a dockerized Oracle12c database</a></li>
<li><a href="#install-elastic-items">1.4. Install Elastic items</a>
<ul class="sectlevel3">
<li><a href="#migration-prerequisites">1.4.1. Migration prerequisites</a></li>
<li><a href="#elasticsearch">1.4.2. Elasticsearch</a></li>
</ul>
</li>
<li><a href="#kibana">1.5. Kibana</a>
<ul class="sectlevel3">
<li><a href="#troubleshoot">1.5.1. Troubleshoot</a>
<ul class="sectlevel4">
<li><a href="#kibana-cannot-connect-to-elasticsearch">Kibana cannot connect to Elasticsearch</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#curator">1.6. Curator</a>
<ul class="sectlevel3">
<li><a href="#automation">1.6.1. Automation</a></li>
<li><a href="#configuration">1.6.2. Configuration</a></li>
</ul>
</li>
<li><a href="#heartbeat">1.7. Heartbeat</a></li>
<li><a href="#logstash">1.8. Logstash</a></li>
<li><a href="#filebeat">1.9. Filebeat</a></li>
<li><a href="#metricbeat">1.10. Metricbeat</a></li>
<li><a href="#grafana">1.11. Grafana</a></li>
<li><a href="#jaeger-tracing-openzipkin-like">1.12. Jaeger Tracing (OpenZipkin-like)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="icon"><a class="image" href="index.html"><i class="fa fa-home"></i></a></span> ‏ ‏ ‎
<span class="icon"><a class="image" href="BP-elastic.adoc"><i class="fa fa-file-text-o"></i></a></span> ‏ ‏ ‎
<span class="icon"><a class="image" href="BP-elastic.pdf"><i class="fa fa-file-pdf-o"></i></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="elastic-servers-configuration"><a class="anchor" href="#elastic-servers-configuration"></a>1. Elastic servers configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="initialize-vm"><a class="anchor" href="#initialize-vm"></a>1.1. Initialize VM</h3>
<div class="ulist">
<ul>
<li>
<p>Adding a user</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ adduser devops</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Granting him root privileges</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ visudo</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>devops ALL=(ALL:ALL) ALL</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Checking FS size</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ parted
$ print free</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Example</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"> Number  Start   End     Size    Type     File system  Flags
        32.3kB  1049kB  1016kB           Free Space
 1      1049kB  500MB   499MB   primary  ext2         boot
 2      500MB   53.7GB  53.2GB  primary               lvm
        53.7GB  53.7GB  1049kB           Free Space</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Below instructions are for Ubuntu only. You can check your Linux distribution with this command : cat /etc/*-release
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Add some server for apt-get</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo vi /etc/apt/sources.list</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ trusty main restricted universe multiverse
deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ trusty-security main restricted universe multiverse
deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ trusty-updates main restricted universe multiverse
deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ trusty-proposed main restricted universe multiverse
deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ trusty-backports main restricted universe multiverse</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="install-docker"><a class="anchor" href="#install-docker"></a>1.2. Install Docker</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Below instructions are for Ubuntu 14 only. You can check your Linux distribution with this command : cat /etc/*-release
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ apt-get install apt-transport-https ca-certificates curl software-properties-common
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
$ add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable"
$ apt-get update
$ apt-cache search docker-ce
$ apt-get install docker-ce</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>May work on Jenkins slave</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
don&#8217;t use on managed PL, we don&#8217;t have enough rights
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") \
   $(lsb_release -cs) \
   stable"
$ sudo apt-get update
$ sudo apt-cache search docker-ce
$ sudo apt-get install --assume-yes docker-ce
$ sudo dockerd</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow Docker remote API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Solution found here <a href="https://forums.docker.com/t/enable-remote-api-on-docker-hosts-in-ubuntu-14/11583/2" class="bare">https://forums.docker.com/t/enable-remote-api-on-docker-hosts-in-ubuntu-14/11583/2</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ vi /etc/default/docker</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ DOCKER_OPTS="-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Start Docker Daemon</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo dockerd</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>To restart (as root)</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Don&#8217;t forget the docker.sock chmod if you use metricbeat
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ service docker restart</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>To check FS size</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"> root@frpardge:/var/lib/docker
 $ du -sh -- * .*
 92K     aufs
 44K     containers
 116K    image
 52K     network
 20K     plugins
 4.0K    swarm
 4.0K    tmp
 4.0K    trust
 28K     volumes
 4.0K    .
 61M     ..</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Get rid of sudo for devops user</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo groupadd docker
$ sudo gpasswd -a devops docker
$ newgrp docker
$ docker run hello-world</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Install <strong>Portainer</strong> to ease administration</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo docker pull portainer/portainer

$ sudo docker run -d --name portainer --restart=always -p 19000:9000 -v /var/run/docker.sock:/var/run/docker.sock portainer/portainer</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>To use, go to <a href="http://frpardge.corp.nvx.com:19000" class="bare">http://frpardge.corp.nvx.com:19000</a></p>
<div class="ulist">
<ul>
<li>
<p>login/password = admin / <strong>*</strong>*</p>
<div class="ulist">
<ul>
<li>
<p>Install docker-compose</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose

chmod +x /usr/local/bin/docker-compose

docker-compose --version</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="define-nexus3-as-the-docker-registry"><a class="anchor" href="#define-nexus3-as-the-docker-registry"></a>1.2.1. Define Nexus3 as the Docker registry</h4>
<div class="ulist">
<ul>
<li>
<p>Raise a ticket in INSERE to ask a port opening for Nexus3 as a Docker registry</p>
<div class="ulist">
<ul>
<li>
<p>They will provide this kind of response, which indicates how to login before 'docker push' :</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker login docker-registry-bpmfactory.s2-eu.nvx.com
 User name: docker
 User Password: dockerPWdbpmfactory</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the information to add the registry in docker configuration</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ vi /etc/docker/daemon.json</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "storage-driver": "devicemapper",
  "insecure-registries": [
    "docker-registry-bpmfactory.s2-eu.nvx.com"
  ],
  "disable-legacy-registry": true
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>be carefull not to have INSECURE_REGISTRY here, it would not start :</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ vim /etc/sysconfig/docker</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"> #INSECURE_REGISTRY='--insecure-registry userbxxy05.socle:8444'</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Redémarrer docker</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ service docker restart</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="setup-a-dockerized-oracle12c-database"><a class="anchor" href="#setup-a-dockerized-oracle12c-database"></a>1.3. Setup a dockerized Oracle12c database</h3>
<div class="paragraph">
<p>Database found here : <a href="https://hub.docker.com/r/sath89/oracle-12c/" class="bare">https://hub.docker.com/r/sath89/oracle-12c/</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker pull sath89/oracle-12c

$ docker run --restart=always --name dbdev -d -p 18080:8080 -p 1521:1521 sath89/oracle-12c

$ docker logs -f feef20144fdc124d7b19d22aaf7bd63cbb837df667cc9764e7bdb5bcafa1af46

 Database not initialized. Initializing database.
 Starting tnslsnr
 Copying database files
 1% complete
 3% complete
 Import finished
 Database ready to use. Enjoy! ;)</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Connect to Oracle Application Express web management console with following settings :</div>
<ul>
<li>
<p>host = <a href="http://frpardge:18080/apex" class="bare">http://frpardge:18080/apex</a></p>
</li>
<li>
<p>workspace = <strong>INTERNAL</strong></p>
</li>
<li>
<p>user = <strong>ADMIN</strong></p>
</li>
<li>
<p>password <strong>0raclE!</strong></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="install-elastic-items"><a class="anchor" href="#install-elastic-items"></a>1.4. Install Elastic items</h3>
<div class="paragraph">
<p>Configuration files are given in next associated sections below. For some of them, some chmod change is needed :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cd ~/elastic
$ chmod go-w ./*.yml</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="migration-prerequisites"><a class="anchor" href="#migration-prerequisites"></a>1.4.1. Migration prerequisites</h4>
<div class="ulist">
<div class="title">If you are upgrading from a previous version of Elastic, you have to do this before anything :</div>
<ul>
<li>
<p>Close data senders using Portainer for containers</p>
<div class="ulist">
<ul>
<li>
<p>Shutdown the IS, or just disable CgElastic &amp; WmMediator packages</p>
</li>
<li>
<p>Stop Heartbeat, Filebeat, Metricbeat containers</p>
</li>
<li>
<p>No need to stop Logstash if Filebeat is closed</p>
</li>
</ul>
</div>
</li>
<li>
<p>Check that nothing is coming in Elasticsearch with Kibana, then stop Kibana container</p>
</li>
<li>
<p>Stop Elasticsearch container</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For now, no data migration has been tried, so no support on it. This will be a fresh new Elasticsearch, and a Kibana with imported dashboards (hoping they still work).</p>
</div>
<div class="paragraph">
<p>Rename all stopped container, to be able to get the initial name on new containers.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect3">
<h4 id="elasticsearch"><a class="anchor" href="#elasticsearch"></a>1.4.2. Elasticsearch</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are new to the Elastic Stack, learn with the excellent official Kibana tutorial :
<a href="https://www.elastic.co/guide/en/kibana/current/getting-started.html" class="bare">https://www.elastic.co/guide/en/kibana/current/getting-started.html</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Install with docker without x-pack</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker pull docker.elastic.co/elasticsearch/elasticsearch-oss:6.0.0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">To start it</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run --restart=always -d --name elastic -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" docker.elastic.co/elasticsearch/elasticsearch-oss:6.0.0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>if elastic stops directly after start with this error</p>
<div class="literalblock">
<div class="content">
<pre>max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]</pre>
</div>
</div>
</li>
<li>
<p>Then type before retry</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo sysctl -w vm.max_map_count=262144</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="kibana"><a class="anchor" href="#kibana"></a>1.5. Kibana</h3>
<div class="ulist">
<ul>
<li>
<p>Install with docker without x-pack</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker pull docker.elastic.co/kibana/kibana-oss:6.0.0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the file described at the end of this section</p>
<div class="literalblock">
<div class="content">
<pre>~/elastic/kibana.yml</pre>
</div>
</div>
</li>
<li>
<p>Start the container</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run --restart=always -d --name kibana -p 5601:5601 -v ~/elastic/kibana.yml:/usr/share/kibana/config/kibana.yml docker.elastic.co/kibana/kibana-oss:6.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that it is up and running : <a href="http://frpardge:5601/" class="bare">http://frpardge:5601/</a></p>
</div>
<div class="ulist">
<div class="title">Once every application is up, you will be able to declare patterns :</div>
<ul>
<li>
<p>cgwmbeat-*</p>
</li>
<li>
<p>heartbeat-*</p>
</li>
<li>
<p>jenkins</p>
</li>
<li>
<p>logstash-*</p>
</li>
<li>
<p>metricbeat-*</p>
</li>
<li>
<p>webmethodsmediator</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">And to apply some Elasticsearch default index configuration :</div>
<ul>
<li>
<p>the limit of 1000 fields by index is a bit low, updated to 2000</p>
</li>
<li>
<p>default is 5 shards per index, too many for dev</p>
</li>
<li>
<p>default is 1 replica, for a single node ES it&#8217;s 0</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">PUT _template/all
{
  "index_patterns" : ["*"],
  "settings": {
    "index.mapping.total_fields.limit": 2000,
    "index.max_docvalue_fields_search": 400,
    "number_of_shards": 1,
    "number_of_replicas": 0
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is something to try, inside the "PUT _template/all", someday, to not have keyword (fixed word) + text (searchable) but only keyword :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">  "dynamic_templates": [
    {
      "match_mapping_type": "string",
      "mapping": {
        "type": "keyword"
      }
    }
  ]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">For Elasticsearch monitoring :</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">  GET /_cat/indices?v
  GET _cluster/health</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">~/elastic/kibana.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># Kibana is served by a back end server. This setting specifies the port to use.
#server.port: 5601

# Specifies the address to which the Kibana server will bind. IP addresses and host names are both valid values.
# The default is 'localhost', which usually means remote machines will not be able to connect.
# To allow connections from remote users, set this parameter to a non-loopback address.
server.host: "0.0.0.0"

# Enables you to specify a path to mount Kibana at if you are running behind a proxy. This only affects
# the URLs generated by Kibana, your proxy is expected to remove the basePath value before forwarding requests
# to Kibana. This setting cannot end in a slash.
#server.basePath: ""

# The maximum payload size in bytes for incoming server requests.
#server.maxPayloadBytes: 1048576

# The Kibana server's name.  This is used for display purposes.
#server.name: "your-hostname"

# The URL of the Elasticsearch instance to use for all your queries.
elasticsearch.url: "http://frpardge.corp.nvx.com:9200"

# When this setting's value is true Kibana uses the hostname specified in the server.host
# setting. When the value of this setting is false, Kibana uses the hostname of the host
# that connects to this Kibana instance.
#elasticsearch.preserveHost: true

# Kibana uses an index in Elasticsearch to store saved searches, visualizations and
# dashboards. Kibana creates a new index if the index doesn't already exist.
#kibana.index: ".kibana"

# The default application to load.
#kibana.defaultAppId: "discover"

# If your Elasticsearch is protected with basic authentication, these settings provide
# the username and password that the Kibana server uses to perform maintenance on the Kibana
# index at startup. Your Kibana users still need to authenticate with Elasticsearch, which
# is proxied through the Kibana server.
#elasticsearch.username: "user"
#elasticsearch.password: "pass"

# Enables SSL and paths to the PEM-format SSL certificate and SSL key files, respectively.
# These settings enable SSL for outgoing requests from the Kibana server to the browser.
#server.ssl.enabled: false
#server.ssl.certificate: /path/to/your/server.crt
#server.ssl.key: /path/to/your/server.key

# Optional settings that provide the paths to the PEM-format SSL certificate and key files.
# These files validate that your Elasticsearch backend uses the same key files.
#elasticsearch.ssl.certificate: /path/to/your/client.crt
#elasticsearch.ssl.key: /path/to/your/client.key

# Optional setting that enables you to specify a path to the PEM file for the certificate
# authority for your Elasticsearch instance.
#elasticsearch.ssl.certificateAuthorities: [ "/path/to/your/CA.pem" ]

# To disregard the validity of SSL certificates, change this setting's value to 'none'.
#elasticsearch.ssl.verificationMode: full

# Time in milliseconds to wait for Elasticsearch to respond to pings. Defaults to the value of
# the elasticsearch.requestTimeout setting.
#elasticsearch.pingTimeout: 1500

# Time in milliseconds to wait for responses from the back end or Elasticsearch. This value
# must be a positive integer.
#elasticsearch.requestTimeout: 30000

# List of Kibana client-side headers to send to Elasticsearch. To send *no* client-side
# headers, set this value to [] (an empty list).
#elasticsearch.requestHeadersWhitelist: [ authorization ]

# Header names and values that are sent to Elasticsearch. Any custom headers cannot be overwritten
# by client-side headers, regardless of the elasticsearch.requestHeadersWhitelist configuration.
#elasticsearch.customHeaders: {}

# Time in milliseconds for Elasticsearch to wait for responses from shards. Set to 0 to disable.
#elasticsearch.shardTimeout: 0

# Time in milliseconds to wait for Elasticsearch at Kibana startup before retrying.
#elasticsearch.startupTimeout: 5000

# Specifies the path where Kibana creates the process ID file.
#pid.file: /var/run/kibana.pid

# Enables you specify a file where Kibana stores log output.
#logging.dest: stdout

# Set the value of this setting to true to suppress all logging output.
#logging.silent: false

# Set the value of this setting to true to suppress all logging output other than error messages.
#logging.quiet: false

# Set the value of this setting to true to log all events, including system usage information
# and all requests.
#logging.verbose: false

# Set the interval in milliseconds to sample system and process performance
# metrics. Minimum is 100ms. Defaults to 5000.
#ops.interval: 5000</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="troubleshoot"><a class="anchor" href="#troubleshoot"></a>1.5.1. Troubleshoot</h4>
<div class="paragraph">
<p>Here is a list of problems and solutions.</p>
</div>
<div class="sect4">
<h5 id="kibana-cannot-connect-to-elasticsearch"><a class="anchor" href="#kibana-cannot-connect-to-elasticsearch"></a>Kibana cannot connect to Elasticsearch</h5>
<div class="paragraph">
<p>If Kibana cannot connect to Elasticsearch with this message :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>blocked by: [FORBIDDEN/12/index read-only / allow delete (api)];: [cluster_block_exception] blocked by: [FORBIDDEN/12/index read-only / allow delete (api)];</pre>
</div>
</div>
<div class="paragraph">
<p>Then apply these settings :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json"> PUT _settings
    {
        "index": {
        "blocks": {
        "read_only_allow_delete": "false"
    }
 PUT cgwmbeat-2018.02.16/_settings
    {
        "index": {
        "blocks": {
        "read_only_allow_delete": "false"
    }</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="curator"><a class="anchor" href="#curator"></a>1.6. Curator</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -

$ sudo vi /etc/apt/sources.list

 deb [arch=amd64] http://packages.elastic.co/curator/5/debian stable main

$ sudo apt-get update &amp;&amp; sudo apt-get install elasticsearch-curator</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">To start it</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curator --config ~/elastic/curator.config.yml --dry-run ~/elastic/curator.delete_indices.yml
$ curator --config ~/elastic/curator.config.yml ~/elastic/curator.delete_indices.yml</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="automation"><a class="anchor" href="#automation"></a>1.6.1. Automation</h4>
<div class="ulist">
<ul>
<li>
<p>Create below script</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">~/elastic/curator.sh</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">#!/bin/sh

curator --config ~/elastic/curator.config.yml ~/elastic/curator.delete_indices.yml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Open crontab</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$  crontab -e</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add this line to launch it at 8:00 everyday</p>
<div class="literalblock">
<div class="content">
<pre>0 8 * * * ~/elastic/curator.sh</pre>
</div>
</div>
</li>
<li>
<p>Exit and save with <strong>Ctrl+X</strong>, <strong>Y</strong>, <strong>Enter</strong></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuration"><a class="anchor" href="#configuration"></a>1.6.2. Configuration</h4>
<div class="listingblock">
<div class="title">~/elastic/curator.config.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
# Remember, leave a key empty if there is no value.  None will be a string,
# not a Python "NoneType"
client:
  hosts:
    - 127.0.0.1
  port: 9200
  url_prefix:
  use_ssl: False
  certificate:
  client_cert:
  client_key:
  ssl_no_validate: False
  http_auth:
  timeout: 30
  master_only: False

logging:
  loglevel: INFO
  logfile:
  logformat: default
  blacklist: ['elasticsearch', 'urllib3']</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">~/elastic/curator.delete_indices.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
# Remember, leave a key empty if there is no value.  None will be a string,
# not a Python "NoneType"
#
# Also remember that all examples have 'disable_action' set to True.  If you
# want to use this action as a template, be sure to set this to False after
# copying it.
# # # #
# curator --config ~/elastic/curator.config.yml --dry-run ~/elastic/curator.delete_indices.yml
# curator --config ~/elastic/curator.config.yml ~/elastic/curator.delete_indices.yml
# # # #
actions:
  1:
    action: delete_indices
    description: Delete indices older than 30 days. No error when no actual deletion.
    options:
      ignore_empty_list: True
    filters:
    - filtertype: age
      source: name
      direction: older
      timestring: '%Y.%m.%d'
      unit: days
      unit_count: 30</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="heartbeat"><a class="anchor" href="#heartbeat"></a>1.7. Heartbeat</h3>
<div class="ulist">
<ul>
<li>
<p>Pull the image</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker pull docker.elastic.co/beats/heartbeat:6.0.0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the file described at the end of this section</p>
<div class="literalblock">
<div class="content">
<pre>~/elastic/heartbeat.yml</pre>
</div>
</div>
</li>
<li>
<p>Start the container</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run --name heartbeat -d -v ~/elastic/heartbeat.yml:/usr/share/heartbeat/heartbeat.yml docker.elastic.co/beats/heartbeat:6.0.0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">~/elastic/heartbeat.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">#
# wget --user=svc-fr-pldouane --password=Na9Is4Aw0! https://cdsdouane.pl.s2-eu.nvx.com/jenkins/job/DTXE_P1_CodeReview/
#
heartbeat.monitors:
- name: Jenkins
  type: http
  schedule: '@every 30s'
  urls: ["https://bpmfactory.s2-eu.nvx.com/jenkins/job/CNAV-DGE_P1_Review/"]
  username: svc-fr-bpmfact
  password: ****
  check.request.method: GET
  check.response.status: 200
- name: 'Jenkins Douane'
  type: http
  schedule: '@every 30s'
  urls: ["https://cdsdouane.pl.s2-eu.nvx.com/jenkins/job/DTXE_P1_CodeReview/"]
  username: svc-fr-pldouane
  password: ****
  check.request.method: GET
  check.response.status: 200
- name: 'Gerrit home'
  type: http
  schedule: '@every 30s'
  urls: ["https://bpmfactory.s2-eu.nvx.com/gerrit/changes/?n=25&amp;O=81"]
  username: svc-fr-bpmfact
  password: ****
  check.response.status: 200
- name: 'Gerrit viewFile'
  type: http
  schedule: '@every 30s'
  urls: ["https://bpmfactory.s2-eu.nvx.com/gerrit/changes/421/revisions/5ab9d4c5cab6a087b936748f2df6550666a502dd/files/Jenkinsfile-2-deploy-to-dev/diff?context=ALL"]
  username: svc-fr-bpmfact
  password: ****
  check.response.status: 200
- name: 'IS Dev'
  type: http
  schedule: '@every 30s'
  urls: ["http://frpardge:5555"]
  username: Administrator
  password: ****
  check.response.status: 200
- name: Kibana
  type: http
  schedule: '@every 30s'
  urls: ["http://frpardge:5601/app/kibana#/management?_g=()"]
  check.response.status: 200
- name: 'UM Dev'
  type: tcp
  schedule: '@every 30s'
  hosts: ["frpardge:9000"]

heartbeat.scheduler:
  limit: 10

output.elasticsearch:
  hosts: ["frpardge.corp.nvx.com:9200"]

dashboards.enabled: true</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="logstash"><a class="anchor" href="#logstash"></a>1.8. Logstash</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Install this only if you have files to be parsed and sent to Elasticsearch</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Pull the image</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker pull docker.elastic.co/logstash/logstash-oss:6.0.0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the file described at the end of this section</p>
<div class="literalblock">
<div class="content">
<pre>~/elastic/logstash-pipelines/logstash.conf</pre>
</div>
</div>
</li>
<li>
<p>Start the container</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run --restart=always --name logstash -d -p 5043:5043 -v ~/elastic/logstash-pipelines/:/usr/share/logstash/pipeline/ docker.elastic.co/logstash/logstash-oss:6.0.0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">~/elastic/logstash-pipelines/logstash.conf</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">input {
    beats {
        port =&gt; "5043"
    }
}

filter {
  if [fields][log_type] == "perflog" {
    grok {
        match =&gt; { "message" =&gt; "%{TIMESTAMP_ISO8601:timestamp} INFO  PERFORMANCES - \[%{GREEDYDATA:package}\] %{WORD:method}\(\) completed successfully in %{NUMBER:duration:int} ms" }
    }
  }
  else {
    grok {
        match =&gt; { "message" =&gt; "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{NOTSPACE:wMCode}\] %{GREEDYDATA:textMsg}" }
    }
  }
  date {
    match =&gt; [ "timestamp", ISO8601 ]
    timezone =&gt; "Europe/Paris"
    target =&gt; "@timestamp"
  }
}

output {
    elasticsearch {
        hosts =&gt; [ "frpardge.corp.nvx.com:9200" ]
    }
    #stdout { codec =&gt; rubydebug }
}</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="filebeat"><a class="anchor" href="#filebeat"></a>1.9. Filebeat</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Install this only if you have files to be parsed and sent to Elasticsearch</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Pull the image</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker pull docker.elastic.co/beats/filebeat:6.0.0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the file described at the end of this section</p>
<div class="literalblock">
<div class="content">
<pre>~/elastic/filebeat.yml</pre>
</div>
</div>
</li>
<li>
<p>Start the container</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run --name filebeat -d -v /opt/sagis/IntegrationServer/instances/default/logs/:/islogs/ -v ~/elastic/filebeat.yml:/usr/share/filebeat/filebeat.yml docker.elastic.co/beats/filebeat:6.0.0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">~/elastic/filebeat.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">filebeat.prospectors:

- type: log
  paths:
    - /islogs/log4j2/perfs.log
  fields: {log_type: perflog}

- type: log
  paths:
    - /islogs/server.log
  multiline.pattern: '^\[20'
  multiline.negate: true
  multiline.match: after
  fields: {log_type: serverlog}

output.logstash:
  hosts: ["frpardge.corp.nvx.com:5043"]</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="metricbeat"><a class="anchor" href="#metricbeat"></a>1.10. Metricbeat</h3>
<div class="paragraph">
<p>This chmod has to be done again after each VM reboot before starting Metricbeat :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo chmod 777 /var/run/docker.sock</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Pull the image</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker pull docker.elastic.co/beats/metricbeat:6.0.0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the file described at the end of this section</p>
<div class="literalblock">
<div class="content">
<pre>~/elastic/metricbeat.yml</pre>
</div>
</div>
</li>
<li>
<p>Start the container</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run --name metricbeat -d -v /var/run/docker.sock:/var/run/docker.sock -v ~/elastic/metricbeat.yml:/usr/share/metricbeat/metricbeat.yml --volume=/proc:/hostfs/proc:ro --volume=/sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro --volume=/:/hostfs:ro --net=host docker.elastic.co/beats/metricbeat:6.0.0 metricbeat -e -system.hostfs=/hostfs</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test you CPU graphs, with the proper handling of the cores, you can use stress application to load one or multiple cores :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo apt-get install stress
$ stress --cpu 2</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">~/elastic/metricbeat.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">metricbeat.modules:
- module: system
  period: 10s
  metricsets:
    - cpu
    #- load
    - memory
    #- network
    - process
    - process_summary
    #- core
    #- diskio
    #- socket
  processes: ['.*']
  process.include_top_n:
    by_cpu: 10      # include top processes by CPU
    by_memory: 10   # include top processes by memory

- module: system
  period: 1m
  metricsets:
    - filesystem
    - fsstat
  processors:
  - drop_event.when.regexp:
      system.filesystem.mount_point: '^/(sys|cgroup|proc|dev|etc|hostfs|run|var)($|/)'

- module: docker
  metricsets:
    #- container
    - cpu
    #- diskio
    #- healthcheck
    #- image
    #- info
    - memory
    #- network
  hosts: ["unix:///var/run/docker.sock"]
  period: 10s

output.elasticsearch:
  hosts: ["frpardge.corp.nvx.com:9200"]

metricbeat.config.modules:
  path: /usr/share/metricbeat/metricbeat.yml
  reload.enabled: true
  reload.period: 60s</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="grafana"><a class="anchor" href="#grafana"></a>1.11. Grafana</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana_4.4.3_amd64.deb

$ sudo apt-get install -y adduser libfontconfig

$ sudo dpkg -i grafana_4.4.3_amd64.deb</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">To start it</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo service grafana-server start</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">To auto start it at boot time</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ sudo update-rc.d grafana-server defaults</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="jaeger-tracing-openzipkin-like"><a class="anchor" href="#jaeger-tracing-openzipkin-like"></a>1.12. Jaeger Tracing (OpenZipkin-like)</h3>
<div class="listingblock">
<div class="title">To start it</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run --restart=always --name jaeger -d -p5775:5775/udp -p6831:6831/udp -p5778:5778 -p16686:16686 jaegertracing/all-in-one:latest</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/commitstrip-elasticsearch.jpg" alt="commitstrip elasticsearch" width="50%">
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-01-10 17:22:49 UTC
</div>
</div>
<link rel="stylesheet" href="lib/highlight/styles/gruvbox-dark.min.css">
<script src="lib/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>