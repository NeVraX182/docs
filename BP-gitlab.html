<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<link rel="shortcut icon" type="image/png" href="themes/favicon.png">
<title>Gitlab Configuration Details</title>
<link rel="stylesheet" href="themes/css/html-zenika.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/c3/0.3.0/c3.min.css">
<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js" charset="utf-8"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/c3/0.3.0/c3.min.js"></script>
<link rel="stylesheet" href="http://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
<script src="http://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Gitlab Configuration Details</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#server-configuration">2. Server configuration</a></li>
<li><a href="#project-creation">3. Project creation</a>
<ul class="sectlevel2">
<li><a href="#configure-rebase-without-merge-commit">3.1. Configure rebase without merge commit</a></li>
<li><a href="#protect-master-branch">3.2. Protect master branch</a></li>
<li><a href="#configure-eclipse">3.3. Configure Eclipse</a></li>
<li><a href="#merge-requests-workflow">3.4. Merge Requests workflow</a></li>
<li><a href="#pipeline-creation">3.5. Pipeline creation</a></li>
</ul>
</li>
<li><a href="#troobleshooting">4. Troobleshooting</a>
<ul class="sectlevel2">
<li><a href="#i-pushed-on-a-deleted-branch">4.1. I pushed on a deleted branch</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="icon"><a class="image" href="index.html"><i class="fa fa-home"></i></a></span> ‏ ‏ ‎
<span class="icon"><a class="image" href="BP-gitlab.adoc"><i class="fa fa-file-text-o"></i></a></span> ‏ ‏ ‎
<span class="icon"><a class="image" href="BP-gitlab.pdf"><i class="fa fa-file-pdf-o"></i></a></span></p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/geek-and-poke-green-on-my-machine.jpg" alt="geek and poke green on my machine" width="33%">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Gitlab in his <a href="https://about.gitlab.com/pricing/#gitlab-com">free online plan</a> offers some nice features :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>2,000 CI pipeline minutes per group per month on our shared runners</p>
</li>
<li>
<p>Unlimited private projects and collaborators</p>
<div class="ulist">
<ul>
<li>
<p>Built-in CI/CD</p>
</li>
<li>
<p>Cycle Analytics</p>
</li>
<li>
<p>Issue Boards</p>
</li>
<li>
<p>Time tracking</p>
</li>
<li>
<p>Preview your changes with Review Apps</p>
</li>
<li>
<p>Publish static websites for free with GitLab Pages</p>
</li>
<li>
<p>Git LFS 2.0 support</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server-configuration"><a class="anchor" href="#server-configuration"></a>2. Server configuration</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/dilbert-homeworking.png" alt="dilbert homeworking" width="50%">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="project-creation"><a class="anchor" href="#project-creation"></a>3. Project creation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Create a project in web interface.</p>
<div class="ulist">
<ul>
<li>
<p>check <strong>Create README.md</strong> or else <strong>master</strong> branch is not created</p>
</li>
</ul>
</div>
</li>
<li>
<p>Import git project in Eclipse</p>
</li>
<li>
<p>Change git config, adding :</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini">  [user]
    name = yourname
    email = youraccount@yourprovider.com</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="configure-rebase-without-merge-commit"><a class="anchor" href="#configure-rebase-without-merge-commit"></a>3.1. Configure rebase without merge commit</h3>
<div class="ulist">
<ul>
<li>
<p>In the web interface, go to <strong>Project</strong> &#8594; <strong>Settings</strong> &#8594; <strong>General</strong> &#8594; <strong>Merge request</strong>, and configure as follow :</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> Fast-forward merge</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Only allow merge requests to be merged if the pipeline succeeds</p>
</li>
<li>
<p><i class="fa fa-square-o"></i> Only allow merge requests to be merged if all discussions are resolved</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/geek-and-poke-it-was-me.jpg" alt="geek and poke it was me" width="33%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="protect-master-branch"><a class="anchor" href="#protect-master-branch"></a>3.2. Protect master branch</h3>
<div class="paragraph">
<p>Gitlab workflow is not as straightforward as Gerrit&#8217;s (see below). In Eclipse, it&#8217;s too easy to push to master instead of our current Merge Request&#8217;s branch.</p>
</div>
<div class="paragraph">
<p>Here is how to protect it :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In Gitlab interface, navigate to your project &#8594; <strong>Settings</strong> &#8594; <strong>Repository</strong> &#8594; expend <strong>Protected Branches</strong> and configure :</p>
<div class="ulist">
<ul>
<li>
<p>Branch = <strong>master</strong></p>
</li>
<li>
<p>Allowed to merge = <strong>Maintainers</strong></p>
</li>
<li>
<p>Allowed to push = <strong>No one</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/commitstrip-wrong-project.jpg" alt="commitstrip wrong project" width="50%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="configure-eclipse"><a class="anchor" href="#configure-eclipse"></a>3.3. Configure Eclipse</h3>
<div class="paragraph">
<p>Clone the repository as you would do for any Git repository, see <a href="BP-Eclipse.html">Eclipse Best Practices</a> for details.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/geek-and-poke-russian-roulette.jpg" alt="geek and poke russian roulette" width="50%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="merge-requests-workflow"><a class="anchor" href="#merge-requests-workflow"></a>3.4. Merge Requests workflow</h3>
<div class="paragraph">
<p>We assume that we will be the only one to push on that branch, so we do not check-out the branch, and just push there. This helps do fewer interactions in Eclipse.</p>
</div>
<div class="ulist">
<div class="title">Initialize the change</div>
<ul>
<li>
<p>In Gitlab</p>
<div class="ulist">
<ul>
<li>
<p>Go to <strong>Issues</strong> &#8594; <strong>New issue</strong></p>
</li>
<li>
<p>Set information and create</p>
</li>
<li>
<p>Click <strong>Create merge request</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p>In Eclipse</p>
<div class="ulist">
<ul>
<li>
<p>right click on your repo &#8594; <strong>Pull</strong></p>
<div class="ulist">
<ul>
<li>
<p>The branch should appear under <strong>Branches</strong> &#8594; <strong>Remote Tracking</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p>In <strong>Remotes</strong> &#8594; <strong>origin</strong>, right click on the second address and choose <strong>Configure Push&#8230;&#8203;</strong></p>
</li>
<li>
<p>Click <strong>Add&#8230;&#8203;</strong></p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>Remote branch = &lt;type the number to get the full branch&gt;</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Force update</p>
</li>
<li>
<p>The specification should be something like</p>
<div class="literalblock">
<div class="content">
<pre>+HEAD:refs/heads/4-minor-asciidoc-changes</pre>
</div>
</div>
</li>
<li>
<p>Press <strong>OK</strong> then <strong>Save</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Eclipse should now be ready to handle smoothly Gitlab workflow. You can check your repository git config which should be like :</p>
</div>
<div class="listingblock">
<div class="title">git/config</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini">  [core]
    repositoryformatversion = 0
    filemode = false
    logallrefupdates = true
  [remote "origin"]
    url = https://gitlab.com/bcouetil/academy.git
    fetch = +refs/heads/*:refs/remotes/origin/*
    push = +HEAD:refs/heads/4-minor-asciidoc-changes
  [branch "master"]
    remote = origin
    merge = refs/heads/master
    rebase = true
  [user]
    name = myname
    email = myaccount@myprovider.com</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">dev iterations</div>
<ul>
<li>
<p>The first time</p>
<div class="ulist">
<ul>
<li>
<p>Update your files&#8230;&#8203;</p>
</li>
<li>
<p>Go to <strong>Git Staging</strong> view</p>
</li>
<li>
<p>Stage your files</p>
</li>
<li>
<p>Hit <strong>Commit and Push&#8230;&#8203;</strong> and <strong>Close</strong></p>
</li>
</ul>
</div>
</li>
<li>
<p>On each new iteration do the same and</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> toggle ON <strong>Amend</strong></p>
</li>
<li>
<p>change the text if needed</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Don&#8217;t toggle on <strong>Add Change-Id</strong>, this changes the behavior of <strong>Commit and Push&#8230;&#8203;</strong> towards Gerrit style.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
More details and screenshots in <a href="BP-eclipse.html">Eclipse Best Practices</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now a pipeline should be launched in Gitlab interface.</p>
</div>
<div class="ulist checklist">
<div class="title">Merge in Gitlab</div>
<ul class="checklist">
<li>
<p>Browse the Merge Request in Gitlab</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Remove source branch</p>
</li>
<li>
<p>Pull in Eclipse to be up to date</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/geek-and-poke-avoid-merge-conflict.jpg" alt="geek and poke avoid merge conflict" width="33%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="pipeline-creation"><a class="anchor" href="#pipeline-creation"></a>3.5. Pipeline creation</h3>
<div class="listingblock">
<div class="title">Pipeline</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">image: maven:latest

stages:
  - build
  - test
  - deploy

variables:
  #MAVEN_CLI_OPTS: "-s cg-settings.xml --batch-mode"
  MAVEN_CLI_OPTS: "--batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository/

build:
  stage: build
  script:
    - apt-get update -qq &amp;&amp; apt-get install -qq --assume-yes libc6-i386
    - mvn clean dependency:purge-local-repository
    - mvn install -DskipTests -Dassembly.skipAssembly=true -Dadoc.skip=true


# the pipeline step must be named 'pages' for gitlab to deploy locally (in addition to github)
pages:
  stage: build
  script:
    #- ./src/scripts/asciidocOnlyModified.sh
    - ./src/scripts/asciidocHistory.sh .
    - apt-get update -qq &amp;&amp; apt-get install -qq --assume-yes graphviz
    - git config --global user.email "gitlab@noreply.com"
    - git config --global user.name "GitLab"
    - mkdir public
    # SAMPLE (launched from his folder to avoid ./ problems)
    - cd cg-asciidoctor-sample
    - mvn
    - cd ..
    - mv --verbose cg-asciidoctor-sample/src/docs/asciidoc/*.adoc cg-asciidoctor-sample/target/generated-docs/
    - mv --verbose cg-asciidoctor-sample/target/generated-docs public/sample
    # ACADEMY
    - mvn generate-resources --non-recursive
    - mv --verbose src/docs/asciidoc/*.adoc target/generated-docs/
    - mv --verbose src/docs/asciidoc/subdocs target/generated-docs/subdocs
    - mvn scm-publish:publish-scm
    - mv target/generated-docs/* public/
  artifacts:
    paths:
      # nothing else than public folder will work :(
      - public
  #only:
  #  - master


unit-test:
  stage: test
  script:
    - mvn clean
    - mvn test -Dcheckstyle.skip=true -Dadoc.skip=true -pl cg-utils

integration-test:
  stage: test
  script:
    - mvn clean
    - mvn verify failsafe:verify -Dcg.ut.skip=true -Dcheckstyle.skip=true -Dadoc.skip=true -pl cg-utils

assembly:
  stage: deploy
  script:
    - mvn clean
    - mvn install -DskipTests -Dcheckstyle.skip=true -Dadoc.skip=true -pl cg-utils
  #only:
  #  - master</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="troobleshooting"><a class="anchor" href="#troobleshooting"></a>4. Troobleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="i-pushed-on-a-deleted-branch"><a class="anchor" href="#i-pushed-on-a-deleted-branch"></a>4.1. I pushed on a deleted branch</h3>
<div class="paragraph">
<p>If you have accidently pushed on a merged branch, it will be recreated.</p>
</div>
<div class="paragraph">
<p>You have to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reset mixed on the master</p>
</li>
<li>
<p>Configure your push to the good branch</p>
</li>
<li>
<p>Push</p>
</li>
<li>
<p>Delete the other branch</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/monkeyuser-merging-branches.jpg" alt="monkeyuser merging branches" width="50%">
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-01-06 19:13:27 UTC
</div>
</div>
<link rel="stylesheet" href="highlight/styles/gruvbox-dark.min.css">
<script src="highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>